## 画像の重ね合わせによるLIR雲追跡の実行方法


### 概要

本研究で用いた、重ね合わせによるLIR雲追跡のコードは2種類あり、それぞれ以下の役割を果たす。
- `cloud_track.py`  緯度経度マッピングされたLIR画像から、相互相関曲面を計算する。(本研究オリジナルの解析手法)
- `summarize.py`  得られた相互相関曲面から推定風速や観測地点のローカルタイムなどをまとめた統計解析用のcsvファイルを作成する(補助)

本コードは `Windows 10`, `Python 3.6.6`, `Anaconda 4.5.11` で実行できることを確認している。用いた仮想環境にインストールした各ライブラリのバージョンは別項(`env.yaml`)にまとめた。

### cloud_track.py 実行手順

1. 実行コードのあるディレクトリに、ディレクトリ`input/`を作成
2. `input/r????内`に雲追跡に用いるLIRソースファイルをコピーする。ただし、????には4桁の軌道番号が入る。
    - 対応ファイルはLIRの緯度経度展開されたL3cのnetCDF4ファイル（画像サイズは経度方向1440、緯度方向720を想定）
    - ファイル名はアーカイブからダウンロードしたままでなければならない。また、各ファイルは全て対応する軌道番号のフォルダ内に置く必要がある。
	    - 例）`input/r0079/lir_20180410_065612_pic_l3c_v20190401.nc`
3. `clud_track.py`内の`orbits = [i for i in range(79,85)]`を解析したい軌道番号が記されたリストに書き換える。この例では軌道番号79〜84の画像を用いて雲追跡を行う。この軌道番号は`input/`内に存在する番号でなければならない。
4. 実行コードのあるディレクトリで`python cloud_track.py`とコマンドを打ち、実行 
5. 実行すると実行コードのあるディレクトリに`output/`が作成され、その中に各軌道番号、軌道番号内グループごとに、相互相関曲面(jpeg形式の画像と曲面を表す2次元配列を格納されたpickleファイル)データと相互相関曲面を作成するときに使った元データのパスや元データの撮影時刻などの情報が記されたcsv形式のファイルが出力される。出力されたpickleファイルは`summerize.py`実行時に必要になる。統計解析時にこれらのデータを直接参照することはない。
    - 例）`output/orbit0079/01/ccmap(806.0, 257.0).pickle`

### summarize.py 実行手順

得られた相互相関曲面群から推定風速や観測地点のローカルタイムなどをまとめた統計解析用のcsvファイルを作成するためのコードであるため、`cloud_track.py`を実行し、必要な相関曲面データが出力された後に実行する必要がある。
1. `summarize.py`内の`orbits = [i for i in range(79,85)]`を解析したい軌道番号が記されたリストに書き換える。この例では軌道番号79〜84の画像を用いて雲追跡を行う。この軌道番号は`output/`内に存在する番号でなければならない。
2. 実行コードのあるディレクトリで`python summarize.py`とコマンドを打ち、実行 
3. 実行すると`output/`以下に、 統計解析用の`summaryCCmap_????.csv`,`.pickle`の2つのファイルが出力される。これらのファイルはどちらも同じ情報が格納された異なるファイル形式である。このファイルに読み込んだ全ての相互相関曲面の特徴量とそれに付随するメタデータが書き込まれている。

#### 統計解析用ファイルの見方
| 名前                       | 説明                                                | 単位など                                    |
|----------------------------|-----------------------------------------------------|---------------------------------------------|
| (#)                        | 行番号                                              |                                             |
| orbit                      | 軌道番号                                            |                                             |
| groupNum                   | 同じ軌道内のグループ番号                            |                                             |
| u                          | 相互相関係数が最大となる東西風速                    | m/s, 対地東西風速から仮定した背景東西風速度を引いた値をcosθ (θは緯度)で割ったもので、角速度に比例する。               |
| v                          | 相互相関係数が最大となる南北風速                    | m/s                                         |
| lt                         | LIR画像における中心のローカルタイムの平均           | hour                                        |
| lat                        | LIR画像における中心の経度の平均                     | degree                                      |
| lon                        | LIR画像における中心の緯度                           | degree                                      |
| time_begin                 | 用いたLIR画像のうち、一番最初に撮影された画像の時刻 |                                             |
| distance_mean              | 撮影時の金星-探査機間の距離の平均                   | 1e4 km                                      |
| maxValue                   | 相互相関係数の最大値                                |                                             |
| region x (x=99,95,90)      | 相関曲面内の上位 100-x %以上の領域の個数            |                                             |
| longestAxes x (x=99,95,90) | 相関曲面内の上位 100-x %以上の領域の長軸の最大値    | pixel/h (相互相関曲面でのピクセル数に換算) |
| path                       | 相互相関曲面2次元データのパス                       |                                             |
